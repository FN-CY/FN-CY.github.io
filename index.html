<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ğŸ·ç†è´¢</title>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --text-sub: #888;
            --red: #eb4d3d; --green: #00a854; --blue: #2196f3; --border: #333;
            --silver: #00d2ff; --purple: #9c27b0; --paste: #ff9800;
        }
        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, "Microsoft YaHei", sans-serif; margin: 0; padding: 15px; }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: 80px; }
        
        .header { position: relative; margin-bottom: 25px; text-align: center; }
        h1 { font-size: 1.5rem; margin: 0; color: var(--text); font-weight: bold; letter-spacing: 1px; }
        .data-btn { 
            position: absolute; right: 0; top: 0; 
            background: #333; color: #ccc; border: 1px solid #555; 
            padding: 5px 10px; font-size: 0.8em; border-radius: 4px; cursor: pointer;
        }

        /* çœ‹æ¿ */
        .dashboard { background-color: var(--card); border-radius: 10px; padding: 20px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .dash-item .label { color: var(--text-sub); font-size: 0.85em; margin-bottom: 5px; }
        .dash-item .val { font-size: 1.8em; font-weight: bold; }
        .up { color: var(--red); } .down { color: var(--green); } .gray { color: var(--text-sub); }

        /* è¾“å…¥ä¸æ“ä½œ */
        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .status-text { font-size: 0.8em; color: #666; }
        
        .input-group { background: var(--card); padding: 15px; border-radius: 10px; border: 1px solid var(--border); display: flex; gap: 10px; margin-bottom: 20px; }
        input { background: #2c2c2c; border: 1px solid #444; color: white; padding: 12px; border-radius: 5px; flex: 1; outline: none; font-size: 1em; width: 80px; }
        button { border: none; padding: 0 15px; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; font-size: 0.9em; white-space: nowrap; }
        .btn-add { background-color: var(--blue); }
        .btn-refresh { background-color: #333; border: 1px solid #555; color: #ccc; font-size: 0.8em; padding: 6px 12px; }

        /* åˆ—è¡¨ */
        .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; border: 1px solid var(--border); background: var(--card); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; color: var(--text-sub); font-size: 0.85em; padding: 12px; border-bottom: 1px solid var(--border); white-space: nowrap;}
        td { padding: 15px 12px; border-bottom: 1px solid #2a2a2a; font-size: 1em; }
        
        .code-tag { background: #2a2a2a; color: #666; font-size: 0.75em; padding: 2px 5px; border-radius: 3px; margin-left: 5px; }
        .time-tag { font-size: 0.75em; color: #555; display: block; margin-top: 4px; }
        
        .silver-mark { color: var(--silver); font-size: 0.8em; margin-left: 5px; border: 1px solid #005a70; padding: 1px 4px; border-radius: 3px;}
        .btn-del { background: none; color: #666; font-size: 1.5em; padding: 0 5px; line-height: 1; vertical-align: middle;}
        .btn-del:hover { color: var(--red); }
        .btn-chart { background: #333; color: #ccc; font-size: 0.8em; padding: 5px 10px; border-radius: 4px; margin-right: 10px; }

        /* å¼¹çª— */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #252525; width: 95%; max-width: 600px; border-radius: 12px; padding: 15px; position: relative; border: 1px solid #444; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-title { font-size: 1.1em; font-weight: bold; }
        .close-modal { background: none; font-size: 1.5em; color: #888; padding: 0; }
        .chart-tabs { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { background: #333; flex: 1; padding: 8px 0; text-align: center; border-radius: 4px; font-size: 0.8em; white-space: nowrap; color: #ccc; }
        .tab-btn.active { background: var(--blue); color: white; }
        .chart-box { background: #fff; border-radius: 4px; padding: 5px; min-height: 200px; display: flex; justify-content: center; align-items: center; }
        .chart-img { width: 100%; height: auto; display: block; }

        /* æ•°æ®ç®¡ç†å¼¹çª— */
        .data-area { width: 100%; height: 150px; background: #111; border: 1px solid #444; color: #aaa; padding: 10px; box-sizing: border-box; font-size: 0.8em; margin-bottom: 10px; border-radius: 5px; resize: none; }
        .data-actions { display: flex; gap: 10px; flex-wrap: wrap;}
        .btn-action { flex: 1; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; min-width: 120px; }
        .btn-backup { background: var(--purple); color: white; }
        .btn-restore { background: #444; color: white; }
        .btn-paste { background: var(--paste); color: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>å°ğŸ·ç†è´¢(â—'â—¡'â—)ï¼</h1>
        <button class="data-btn" onclick="openDataModal()">ğŸ“‚ å¤‡ä»½/å¯¼å…¥</button>
    </div>

    <div class="dashboard">
        <div class="dash-item">
            <div class="label">æ€»æœ¬é‡‘</div>
            <div class="val" id="totalMoney">0.00</div>
        </div>
        <div class="dash-item">
            <div class="label">ä»Šæ—¥é¢„ä¼°ç›ˆäº</div>
            <div class="val" id="totalProfit">0.00</div>
        </div>
    </div>

    <div class="action-bar">
        <div class="status-text" id="statusMsg">å‡†å¤‡å°±ç»ª</div>
        <button class="btn-refresh" onclick="refreshAll()">â†» ç«‹å³åˆ·æ–°</button>
    </div>

    <div class="input-group">
        <input type="tel" id="inCode" placeholder="åŸºé‡‘ä»£ç  (6ä½)" maxlength="6">
        <input type="number" id="inAmt" placeholder="æœ¬é‡‘">
        <button class="btn-add" onclick="addFund()">æ·»åŠ </button>
    </div>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>åŸºé‡‘åç§°</th>
                    <th>æœ¬é‡‘</th>
                    <th>å®æ—¶ä¼°å€¼</th>
                    <th>é¢„ä¼°ç›ˆäº</th>
                    <th style="text-align: right;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="listBody"></tbody>
        </table>
    </div>
    
    <div style="margin-top:20px; font-size:0.8em; color:#555; text-align:center; padding:10px; background:#191919; border-radius:8px;">
        âš ï¸ <strong>æç¤ºï¼š</strong><br>
        å°ğŸ·ç†è´¢æé†’æ‚¨ï¼šæŠ•èµ„æœ‰é£é™©ï¼Œä¹°å…¥éœ€è°¨æ…ï¼<br>
        å°ğŸ·ç†è´¢åšä¿¡ï¼šé˜³å…‰æ€»åœ¨é£é›¨åğŸŒˆâ€”â€”é£æµªè¶Šå¤§ï¼Œé±¼è¶Šè´µï¼ğŸŸ
    </div>
</div>

<!-- èµ°åŠ¿å›¾å¼¹çª— -->
<div class="modal-overlay" id="chartModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">åŸºé‡‘èµ°åŠ¿</div>
            <button class="close-modal" onclick="closeChart()">Ã—</button>
        </div>
        <div class="chart-tabs">
            <button class="tab-btn active" onclick="switchChart('today')">ä»Šæ—¥</button>
            <button class="tab-btn" onclick="switchChart('1m')">1æœˆ</button>
            <button class="tab-btn" onclick="switchChart('3m')">3æœˆ</button>
            <button class="tab-btn" onclick="switchChart('6m')">åŠå¹´</button>
            <button class="tab-btn" onclick="switchChart('1y')">1å¹´</button>
            <button class="tab-btn" onclick="switchChart('3y')">3å¹´</button>
        </div>
        <div class="chart-box">
            <img id="chartImg" class="chart-img" src="" alt="åŠ è½½ä¸­...">
        </div>
    </div>
</div>

<!-- æ•°æ®ç®¡ç†å¼¹çª— -->
<div class="modal-overlay" id="dataModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">æ•°æ®ç®¡ç†</div>
            <button class="close-modal" onclick="closeDataModal()">Ã—</button>
        </div>
        <textarea id="dataArea" class="data-area" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´åŸºé‡‘è½¯ä»¶å¤åˆ¶çš„æ–‡å­—..."></textarea>
        
        <div class="data-actions">
            <button class="btn-action btn-backup" onclick="exportData()">å¤åˆ¶å¯¼å‡º (å¤‡ä»½)</button>
            <button class="btn-action btn-paste" onclick="importFromText()">ğŸ“‹ ç²˜è´´æ–‡æœ¬å¯¼å…¥</button>
        </div>
        <div style="margin-top:10px; font-size:0.8em; color:#888;">
            * æ¨èä½¿ç”¨â€œç²˜è´´æ–‡æœ¬å¯¼å…¥â€ï¼Œå¯ä¸€æ¬¡æ€§è§£æå¤šä¸ªåŸºé‡‘ï¼Œæ— è§†åŠ è½½é—®é¢˜ã€‚
        </div>
    </div>
</div>

<script>
    let myFunds = [];
    const STORAGE_KEY = 'fn_master_data'; 
    const BASE_URL = "https://fundgz.1234567.com.cn/js/";
    const SILVER_FUNDS = ['161226', '019005', '019004', '501025'];
    
    let latestSilverData = { pct: 0, time: '', ready: false };
    let currentChartCode = '';
    let chartTimer = null;

    window.onload = () => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) myFunds = JSON.parse(saved);
        
        // å®šä¹‰å…¨å±€å›è°ƒå‡½æ•° (è§£å†³æ‰¹é‡å¯¼å…¥æ—¶çš„å¹¶å‘è¦†ç›–é—®é¢˜)
        window.jsonpgz = function(data) {
            // æ”¶åˆ°æ•°æ®åï¼Œéå†åˆ—è¡¨æ‰¾åˆ°å¯¹åº”çš„åŸºé‡‘å¹¶æ›´æ–°
            // æ³¨æ„ï¼šdata.fundcode æ˜¯å­—ç¬¦ä¸²ï¼ŒmyFundsé‡Œçš„codeä¹Ÿæ˜¯å­—ç¬¦ä¸²
            const target = myFunds.find(f => f.code === data.fundcode);
            if(target) {
                target.name = data.name;
                target.gszzl = parseFloat(data.gszzl);
                target.time = data.gztime;
                target.useSilver = false;
                
                // ç™½é“¶é€»è¾‘
                if(target.isSilver && latestSilverData.ready) {
                    target.gszzl = latestSilverData.pct;
                    target.time = latestSilverData.time;
                    target.useSilver = true;
                }
                
                // æ”¶åˆ°ä¸€ä¸ªæ›´æ–°ä¸€ä¸ªï¼Œé¿å…ç­‰å¾…
                save();
                render();
            }
        };

        render();
        if (myFunds.length > 0) refreshAll();
        setInterval(refreshAll, 45000);
    };

    // --- æ–‡æœ¬å¯¼å…¥é€»è¾‘ ---
    function importFromText() {
        const text = document.getElementById('dataArea').value;
        if(!text.trim()) return alert("è¯·å…ˆç²˜è´´æ–‡å­—");
        const cleanText = text.replace(/Â¥/g, '').replace(/,/g, '').replace(/\s+/g, ' ');
        // åŒ¹é…é€»è¾‘: ä»£ç (6ä½) + ä»»æ„å­—ç¬¦ + é‡‘é¢
        const tokens = cleanText.split(' ');
        let newItems = [];
        
        for(let i=0; i<tokens.length; i++) {
            const token = tokens[i];
            if(/^\d{6}$/.test(token)) {
                const code = token;
                let amt = 0;
                // å‘åæ‰¾é‡‘é¢
                for(let j=1; j<=5; j++) {
                    if(i+j >= tokens.length) break;
                    const val = parseFloat(tokens[i+j]);
                    if(!isNaN(val) && val > 50 && (val < 2020 || val > 2030)) {
                        amt = val;
                        break;
                    }
                }
                if(amt > 0) {
                    // å»é‡
                    if(!myFunds.some(f=>f.code===code) && !newItems.some(f=>f.code===code)) {
                        newItems.push({
                            id: Date.now() + Math.random(),
                            code: code,
                            name: "åŠ è½½ä¸­...",
                            amt: amt,
                            gszzl: 0, time: "--:--",
                            isSilver: SILVER_FUNDS.includes(code)
                        });
                    }
                }
            }
        }

        if(newItems.length > 0) {
            myFunds = [...myFunds, ...newItems];
            save(); render(); closeDataModal();
            // é‡ç‚¹ï¼šå¯¼å…¥åç«‹å³åˆ·æ–°ï¼Œå› ä¸ºæœ‰äº†å…¨å±€å›è°ƒï¼Œè¿™æ¬¡ä¸ä¼šå¡æ­»äº†
            refreshAll(); 
            alert(`æˆåŠŸå¯¼å…¥ ${newItems.length} ä¸ªåŸºé‡‘ï¼Œæ­£åœ¨è·å–æ•°æ®...`);
        } else {
            alert("æœªè¯†åˆ«åˆ°æ•°æ®ï¼Œè¯·ç¡®ä¿å¤åˆ¶äº†ä»£ç å’Œé‡‘é¢");
        }
    }

    // --- æ ¸å¿ƒåˆ·æ–°é€»è¾‘ (ä¿®å¤ç‰ˆ) ---
    async function refreshAll() {
        if (myFunds.length === 0) return;
        const statusEl = document.getElementById('statusMsg');
        
        // 1. å…ˆæ‹¿ç™½é“¶
        if(myFunds.some(f => f.isSilver)) {
            statusEl.innerText = "æ­£åœ¨è·å–å›½é™…é“¶ä»·..."; statusEl.style.color = "#00d2ff";
            await fetchSilverPrice();
        }

        statusEl.innerText = "æ­£åœ¨åŒæ­¥åŸºé‡‘å‡€å€¼..."; statusEl.style.color = "#2196f3";

        // 2. æ‰¹é‡å‘å‡ºè¯·æ±‚
        // å…³é”®ä¿®æ”¹ï¼šä¸å†åœ¨å¾ªç¯é‡Œå®šä¹‰ window.jsonpgzï¼Œè€Œæ˜¯ä½¿ç”¨ window.onload é‡Œå®šä¹‰çš„å…¨å±€å›è°ƒ
        myFunds.forEach(fund => {
            const script = document.createElement('script');
            script.src = `${BASE_URL}${fund.code}.js?rt=${Date.now()}`;
            script.onerror = () => { console.log("åŠ è½½å¤±è´¥: " + fund.code); }; 
            document.body.appendChild(script);
            
            // æ¸…ç†æ ‡ç­¾
            setTimeout(() => { if(script.parentNode) script.parentNode.removeChild(script); }, 5000);
        });
        
        // è¿™é‡Œçš„â€œæ›´æ–°æˆåŠŸâ€åªæ˜¯è¡¨ç¤ºè¯·æ±‚å‘å®Œäº†ï¼Œå…·ä½“æ•°æ®æ›´æ–°ç”± jsonpgz å›è°ƒå¤„ç†
        setTimeout(() => {
             statusEl.innerText = "åŒæ­¥è¯·æ±‚å·²å‘é€ " + new Date().toLocaleTimeString();
             statusEl.style.color = "#00a854";
        }, 1000);
    }

    function fetchSilverPrice() {
        return new Promise((resolve) => {
            const script = document.createElement('script');
            script.src = `https://hq.sinajs.cn/list=hf_XAG&_t=${Date.now()}`;
            script.onload = () => {
                if(window.hq_str_hf_XAG) {
                    try {
                        const parts = window.hq_str_hf_XAG.split(',');
                        const current = parseFloat(parts[0]);
                        const prevClose = parseFloat(parts[7]);
                        if(prevClose > 0) {
                            const pct = ((current - prevClose) / prevClose) * 100;
                            latestSilverData.pct = parseFloat(pct.toFixed(2));
                            const d = new Date();
                            latestSilverData.time = "å›½é™… " + d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
                            latestSilverData.ready = true;
                        }
                    } catch(e) {}
                }
                document.body.removeChild(script); resolve();
            };
            script.onerror = () => { document.body.removeChild(script); resolve(); };
            document.body.appendChild(script);
        });
    }

    // --- åŸºç¡€åŠŸèƒ½ ---
    function openDataModal() { document.getElementById('dataArea').value = ''; document.getElementById('dataModal').style.display = 'flex'; }
    function closeDataModal() { document.getElementById('dataModal').style.display = 'none'; }
    function exportData() {
        if(myFunds.length === 0) return alert("æ— æ•°æ®");
        const json = JSON.stringify(myFunds);
        document.getElementById('dataArea').value = json;
        document.getElementById('dataArea').select();
        document.execCommand('copy');
        alert("å·²å¤åˆ¶å¤‡ä»½æ•°æ®");
    }
    
    function addFund() {
        const code = document.getElementById('inCode').value.trim();
        const amt = parseFloat(document.getElementById('inAmt').value);
        if (!code || code.length !== 6 || isNaN(amt)) return alert("è¾“å…¥é”™è¯¯");
        myFunds.push({
            id: Date.now(), code: code, name: "åŠ è½½ä¸­...", amt: amt,
            gszzl: 0, time: "--:--", isSilver: SILVER_FUNDS.includes(code)
        });
        save(); render(); refreshAll();
        document.getElementById('inCode').value = ''; document.getElementById('inAmt').value = '';
    }

    function render() {
        const tbody = document.getElementById('listBody'); tbody.innerHTML = '';
        let totalM = 0, totalP = 0;
        myFunds.forEach(f => {
            const profit = f.amt * (f.gszzl / 100);
            totalM += f.amt; totalP += profit;
            const color = f.gszzl > 0 ? 'up' : (f.gszzl < 0 ? 'down' : 'gray');
            const sign = f.gszzl > 0 ? '+' : '';
            let codeHtml = `<span class="code-tag">${f.code}</span>`;
            if(f.useSilver) codeHtml += `<span class="silver-mark">å›½é™…</span>`;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><div>${f.isSilver ? '<span style="margin-right:2px">ğŸª™</span>' : ''}${f.name}</div>${codeHtml}</td>
                <td>Â¥${f.amt.toLocaleString()}</td>
                <td><span class="${color}" style="font-weight:bold">${sign}${f.gszzl}%</span><span class="time-tag">${f.time}</span></td>
                <td class="${color}">${sign}${profit.toFixed(2)}</td>
                <td style="text-align: right;"><button class="btn-chart" onclick="openChart('${f.code}', '${f.name}')">ğŸ“‰èµ°åŠ¿</button><button class="btn-del" onclick="del(${f.id})">Ã—</button></td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById('totalMoney').innerText = totalM.toLocaleString();
        const pEl = document.getElementById('totalProfit');
        pEl.innerText = (totalP > 0 ? '+' : '') + totalP.toFixed(2);
        pEl.className = 'val ' + (totalP > 0 ? 'up' : (totalP < 0 ? 'down' : 'gray'));
    }

    function del(id) { if(confirm('åˆ é™¤?')) { myFunds = myFunds.filter(f => f.id !== id); save(); render(); } }
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(myFunds)); }
    
    function openChart(code, name) { currentChartCode = code; document.getElementById('modalTitle').innerText = name; document.getElementById('chartModal').style.display = 'flex'; switchChart('today'); }
    function closeChart() { document.getElementById('chartModal').style.display = 'none'; if(chartTimer) clearInterval(chartTimer); }
    function switchChart(type) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        const btns = document.querySelectorAll('.tab-btn');
        if(type==='today') btns[0].classList.add('active'); if(type==='1m') btns[1].classList.add('active'); if(type==='3m') btns[2].classList.add('active');
        if(type==='6m') btns[3].classList.add('active'); if(type==='1y') btns[4].classList.add('active'); if(type==='3y') btns[5].classList.add('active');
        const img = document.getElementById('chartImg'); const ts = Date.now(); if(chartTimer) clearInterval(chartTimer);
        if (type === 'today') {
            img.src = `https://j4.dfcfw.com/charts/pic/${currentChartCode}.png?v=${ts}`;
            chartTimer = setInterval(() => { img.src = `https://j4.dfcfw.com/charts/pic/${currentChartCode}.png?v=${Date.now()}`; }, 30000);
        } else {
            let pType = 1; if(type==='3m') pType=2; if(type==='6m') pType=3; if(type==='1y') pType=4; if(type==='3y') pType=5;
            img.src = `https://j3.dfcfw.com/images/JJJZ${pType}/${currentChartCode}.png?v=${ts}`;
        }
    }
    document.getElementById('chartModal').addEventListener('click', function(e){ if(e.target===this) closeChart(); });
    document.getElementById('dataModal').addEventListener('click', function(e){ if(e.target===this) closeDataModal(); });
</script>
</body>
</html>

