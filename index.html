<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FN-CY èµ„äº§ | Pro</title>
    <style>
        :root {
            --bg-body: #FFFFFF;
            --bg-secondary: #F5F5F7;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --border: #E5E5E5;
            --accent: #000000;
            --blue: #0066CC;
            --red: #D92D20;
            --green: #008040;
            --radius: 12px;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        body { background: var(--bg-body); color: var(--text-primary); font-family: -apple-system, "SF Pro Text", sans-serif; margin: 0; padding: 0; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid var(--border); margin-bottom: 30px; }
        .brand { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
        .head-btn { background: none; border: none; font-size: 13px; color: var(--blue); cursor: pointer; font-weight: 500; }
        
        /* èµ„äº§æ¦‚è§ˆ */
        .hero { text-align: center; margin-bottom: 40px; }
        .hero h2 { font-size: 13px; color: var(--text-secondary); font-weight: 500; margin-bottom: 5px; }
        .hero .val { font-size: 48px; font-weight: 700; letter-spacing: -1.5px; line-height: 1.1; margin-bottom: 10px; }
        .hero .profit { font-size: 16px; font-weight: 600; padding: 4px 12px; background: var(--bg-secondary); border-radius: 20px; display: inline-flex; align-items: center; gap: 5px;}
        .settle-btn { margin-left: 10px; font-size: 11px; background: var(--accent); color: #fff; padding: 4px 10px; border-radius: 12px; cursor: pointer; border: none; vertical-align: middle; }
        
        /* å·¥å…·æ ï¼šä»¿å›¾äºŒ */
        .toolbar-container { margin-bottom: 25px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .my-input { background: var(--bg-secondary); border: none; padding: 12px 15px; border-radius: 8px; font-size: 14px; outline: none; flex: 1; min-width: 0; color: var(--text-primary); }
        .btn-add { background: #000000; color: #fff; border: none; padding: 0 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; white-space: nowrap; }
        
        .action-row { display: flex; justify-content: space-between; align-items: center; }
        .btn-refresh { background: var(--bg-secondary); color: var(--text-primary); border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
        .right-actions { display: flex; gap: 10px; align-items: center; }
        .view-controls { display: flex; gap: 5px; background: #fff; }
        .icon-btn { background: var(--bg-secondary); border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; color: var(--text-secondary); display: flex; justify-content: center; align-items: center; }
        .icon-btn.active { background: #E5E5E5; color: var(--text-primary); }
        .sort-select { background: transparent; border: none; font-size: 13px; color: var(--text-secondary); cursor: pointer; outline: none; }

        /* åˆ—è¡¨/ç½‘æ ¼åˆ‡æ¢å®¹å™¨ */
        .fund-container { display: grid; gap: 15px; }
        .fund-container.grid-mode { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
        .fund-container.list-mode { grid-template-columns: 1fr; }
        
        .card { background: #fff; border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; position: relative; transition: box-shadow 0.2s; }
        
        /* åˆ—è¡¨æ¨¡å¼ï¼šæ‹‰å¼€é—´éš™ */
        .list-mode .card { display: flex; align-items: center; padding: 15px 20px; gap: 15px; }
        .list-mode .card-head { margin-bottom: 0; flex: 1; min-width: 150px; }
        .list-mode .card-body { flex: 0 0 auto; display: flex; gap: 45px; border-top: none; padding-top: 0; margin-right: 20px; justify-content: flex-end; }
        .list-mode .cb-item { text-align: right; min-width: 85px; }
        .list-mode .card-actions { margin-top: 0; flex: 0 0 auto; }
        
        /* å­—ä½“ä¸é¢œè‰² */
        .f-name { font-size: 15px; font-weight: 600; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .f-code { font-size: 12px; color: var(--text-secondary); background: var(--bg-secondary); padding: 1px 5px; border-radius: 4px; }
        .f-rate { font-size: 20px; font-weight: 700; margin-top: 5px; }
        .f-time { font-size: 10px; color: #ccc; }
        .card-body { display: flex; justify-content: space-between; border-top: 1px solid var(--bg-secondary); padding-top: 12px; font-size: 13px; }
        .cb-item label { display: block; font-size: 10px; color: var(--text-secondary); margin-bottom: 3px; }
        .cb-item span { font-weight: 600; }
        .up { color: var(--red); } .down { color: var(--green); } .gray { color: var(--text-secondary); }
        
        .btn-link { background: none; border: none; color: var(--blue); font-size: 12px; cursor: pointer; }

        /* å¼¹çª—æ ·å¼ */
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); backdrop-filter: blur(8px); z-index: 999; display: none; align-items: center; justify-content: center; }
        .modal { background: #fff; padding: 25px; border-radius: 20px; width: 90%; max-width: 480px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid var(--border); position: relative; }
        .close-m { position: absolute; top: 15px; right: 15px; background: #f0f0f0; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; }
        textarea { width: 100%; height: 200px; background: var(--bg-secondary); border: none; border-radius: 10px; padding: 12px; margin: 15px 0; box-sizing: border-box; font-size: 12px; font-family: monospace; line-height: 1.5; outline: none; }
        .m-btn { width: 100%; padding: 12px; border: none; background: var(--accent); color: #fff; border-radius: 10px; font-weight: 600; cursor: pointer; margin-bottom: 10px; }
        .footer { margin-top: 40px; text-align: center; font-size: 12px; color: var(--text-secondary); border-top: 1px solid var(--border); padding-top: 20px; padding-bottom: 40px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="brand">å°ğŸ·ç†è´¢</div>
        <button class="head-btn" onclick="showModal('data')">æ•°æ®ç®¡ç†</button>
    </div>

    <div class="hero">
        <h2>æ€»èµ„äº§ä¼°å€¼ (CNY)</h2>
        <div class="val" id="totalMoney">0.00</div>
        <div>
            <span class="profit" id="totalProfit">+0.00</span>
            <button class="settle-btn" onclick="settleAccounts()">ğŸ’° ä¸€é”®ç»“ç®—(ç¡®è®¤åæ˜å¤©æ›´æ–°æœ€æ–°èµ„äº§)</button>
        </div>
    </div>

    <div class="toolbar-container">
        <div class="input-row">
            <input type="tel" id="inCode" class="my-input" placeholder="è¾“å…¥ä»£ç  (6ä½)">
            <input type="number" id="inAmt" class="my-input" placeholder="è¾“å…¥æœ¬é‡‘">
            <button class="btn-add" onclick="addFund()">æ·»åŠ </button>
        </div>
        <div class="action-row">
            <button class="btn-refresh" onclick="refreshAll()">â†» æ‰‹åŠ¨åˆ·æ–°</button>
            <div class="right-actions">
                <select class="sort-select" onchange="sortFunds(this.value)">
                    <option value="default">é»˜è®¤æ’åº</option>
                    <option value="up">æ¶¨å¹… (ä½â†’é«˜)</option>
                    <option value="down">æ¶¨å¹… (é«˜â†’ä½)</option>
                    <option value="amt">æœ¬é‡‘ (é«˜â†’ä½)</option>
                </select>
                <div class="view-controls">
                    <button class="icon-btn active" id="btnGrid" onclick="switchView('grid')">âŠ</button>
                    <button class="icon-btn" id="btnList" onclick="switchView('list')">â˜°</button>
                </div>
            </div>
        </div>
    </div>

    <div style="text-align:center; font-size:12px; color:#aaa; margin-bottom:15px;" id="statusMsg">å°±ç»ª</div>
    <div class="fund-container grid-mode" id="fundContainer"></div>
    
    <div class="footer">
        å°ğŸ·ç†è´¢æé†’æ‚¨ï¼šæŠ•èµ„æœ‰é£é™©ï¼Œä¹°å…¥éœ€è°¨æ…ï¼<br>
        å°ğŸ·ç†è´¢åšä¿¡ï¼šé˜³å…‰æ€»åœ¨é£é›¨åğŸŒˆâ€”â€”é£æµªè¶Šå¤§ï¼Œé±¼è¶Šè´µï¼ğŸŸ 
    </div>
</div>

<div class="modal-mask" id="dataModal">
    <div class="modal">
        <button class="close-m" onclick="hideModal('data')">Ã—</button>
        <h3>æ™ºèƒ½è¯†åˆ«å¯¼å…¥</h3>
        <p style="font-size: 12px; color: #888; margin-top:5px;">
            ä½ å¯ä»¥ç›´æ¥ç²˜è´´æ•´é¡µæ–‡å­—ã€‚<br>
            <b>åŸç†ï¼š</b>æŒ‰é¡ºåºæå–æ–‡æœ¬ä¸­çš„â€œ6ä½ä»£ç â€ä¸â€œæœ¬é‡‘é‡‘é¢â€è¿›è¡Œè‡ªåŠ¨é…å¯¹ã€‚
        </p>
        <textarea id="dataInput" placeholder="åœ¨æ­¤ç²˜è´´... 
ä¾‹å¦‚ï¼š
013346 
016708
æœ¬é‡‘ï¼š
725.02
2272.4"></textarea>
        <button class="m-btn" onclick="importSmart()">âš¡ æ·±åº¦æ‰«æå¹¶å¯¼å…¥</button>
        <button class="m-btn" style="background:#eee; color:#333" onclick="exportData()">å¤åˆ¶å¤‡ä»½ä»£ç </button>
    </div>
</div>

<script>
    let myFunds = [];
    let currentSort = 'default';
    const KEY = 'fn_pro_v2';

    window.onload = function() {
        const saved = localStorage.getItem(KEY);
        if (saved) myFunds = JSON.parse(saved);
        const view = localStorage.getItem('fn_view_mode') || 'grid';
        switchView(view);

        window.jsonpgz = function(data) {
            const f = myFunds.find(item => item.code === data.fundcode);
            if(f) {
                f.name = data.name;
                f.gszzl = parseFloat(data.gszzl);
                f.time = data.gztime;
                save(); render();
            }
        };

        render();
        if (myFunds.length > 0) refreshAll();
        setInterval(refreshAll, 30000);
    };

    function addFund() {
        const c = document.getElementById('inCode').value.trim();
        const a = parseFloat(document.getElementById('inAmt').value);
        if(c.length!==6 || isNaN(a)) return alert("è¾“å…¥æœ‰è¯¯");
        myFunds.push({ id: Date.now(), code: c, name: "åŠ è½½ä¸­...", amt: a, gszzl: 0, time: "--" });
        save(); render(); refreshAll();
        document.getElementById('inCode').value=''; document.getElementById('inAmt').value='';
    }

    // --- å‡çº§ç‰ˆï¼šæ™ºèƒ½æ·±åº¦è¯†åˆ«å¯¼å…¥ ---
    function importSmart() {
        const text = document.getElementById('dataInput').value.trim();
        if (!text) return;

        // 1. å°è¯• JSON å¯¼å…¥
        try {
            const json = JSON.parse(text);
            if (Array.isArray(json)) {
                if(confirm("è¯†åˆ«åˆ°å¤‡ä»½ä»£ç ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ")) {
                    myFunds = json;
                    finishImport();
                }
                return;
            }
        } catch (e) {}

        // 2. æ·±åº¦æ‰«æé€»è¾‘
        // æå–æ‰€æœ‰ 6 ä½æ•°å­—ä»£ç 
        const codeMatches = text.match(/\b\d{6}\b/g) || [];
        
        // æå–æ‰€æœ‰å¯èƒ½çš„é‡‘é¢ï¼ˆæ’é™¤æ‰åˆšæ‰è¯†åˆ«å‡ºçš„ä»£ç ï¼‰
        // æˆ‘ä»¬å¯»æ‰¾å¸¦æœ‰å°æ•°ç‚¹ã€æˆ–è€…å¸¦æœ‰è´§å¸ç¬¦å·ã€æˆ–è€…åƒåˆ†ä½çš„æ•°å­—
        const amountCandidates = text.match(/[Â¥ï¿¥]?\s?[\d,]+(\.\d+)/g) || [];
        // å¦‚æœæ²¡æ‰¾åˆ°å¸¦å°æ•°ç‚¹çš„ï¼Œå†å°è¯•æ‰¾æ™®é€šçš„æ•°å­—ï¼ˆä½†è¦è¿‡æ»¤æ‰é‚£å‡ ä¸ª6ä½ä»£ç ï¼‰
        let amounts = amountCandidates.map(a => parseFloat(a.replace(/[Â¥ï¿¥,\s]/g, '')));
        
        // å¦‚æœå¸¦å°æ•°ç‚¹çš„é‡‘é¢ä¸è¶³ï¼Œè¡¥å……æ™®é€šæ•°å­—
        if (amounts.length < codeMatches.length) {
            const allNums = text.match(/[\d,.]+/g) || [];
            const filteredNums = allNums.filter(n => {
                const clean = n.replace(/,/g, '');
                return !codeMatches.includes(clean); // æ’é™¤æ‰ä»£ç æœ¬èº«
            });
            amounts = filteredNums.map(n => parseFloat(n.replace(/,/g, '')));
        }

        if (codeMatches.length === 0) {
            alert("æœªåœ¨æ–‡æœ¬ä¸­è¯†åˆ«åˆ° 6 ä½åŸºé‡‘ä»£ç ã€‚");
            return;
        }

        const count = Math.min(codeMatches.length, amounts.length);
        if (count === 0) {
            alert("è¯†åˆ«åˆ°äº†ä»£ç ï¼Œä½†æ²¡æ‰¾åˆ°å¯¹åº”çš„æœ¬é‡‘é‡‘é¢ã€‚");
            return;
        }

        const imported = [];
        for (let i = 0; i < count; i++) {
            imported.push({
                id: Date.now() + i,
                code: codeMatches[i],
                name: "æ‰«æä¸­...",
                amt: amounts[i],
                gszzl: 0,
                time: "--"
            });
        }

        const msg = `æ‰«æç»“æœï¼š\nå·²è¯†åˆ«å‡º ${codeMatches.length} ä¸ªä»£ç \nå·²è¯†åˆ«å‡º ${amounts.length} ä¸ªé‡‘é¢\n\nå°†è‡ªåŠ¨é…å¯¹å‰ ${count} ç»„æ•°æ®ã€‚æ˜¯å¦å¯¼å…¥ï¼Ÿ`;
        if (confirm(msg)) {
            const action = confirm("ç‚¹å‡»ã€ç¡®å®šã€‘æ›¿æ¢ç°æœ‰åˆ—è¡¨ï¼Œç‚¹å‡»ã€å–æ¶ˆã€‘è¿½åŠ åˆ°æœ«å°¾ã€‚");
            myFunds = action ? imported : [...myFunds, ...imported];
            finishImport();
        }
    }

    function finishImport() {
        save(); render(); refreshAll();
        hideModal('data');
        alert("å¯¼å…¥æˆåŠŸï¼");
    }

    function exportData() {
        document.getElementById('dataInput').value = JSON.stringify(myFunds);
        document.getElementById('dataInput').select();
        document.execCommand('copy');
        alert("å¤‡ä»½ä»£ç å·²å¤åˆ¶ï¼");
    }

    // --- åŸºç¡€æ¸²æŸ“ä¸é€»è¾‘ ---
    function refreshAll() {
        document.getElementById('statusMsg').innerText = "åŒæ­¥ä¸­...";
        myFunds.forEach(f => {
            const s = document.createElement('script');
            s.src = `https://fundgz.1234567.com.cn/js/${f.code}.js?rt=${Date.now()}`;
            document.body.appendChild(s);
            setTimeout(() => { if(s.parentNode) s.parentNode.removeChild(s); }, 3000);
        });
        setTimeout(() => document.getElementById('statusMsg').innerText = "æœ€åæ›´æ–°: " + new Date().toLocaleTimeString(), 1200);
    }

    function render() {
        const container = document.getElementById('fundContainer');
        container.innerHTML = '';
        let totalM = 0, totalP = 0;

        let list = [...myFunds];
        if (currentSort === 'up') list.sort((a,b) => a.gszzl - b.gszzl);
        if (currentSort === 'down') list.sort((a,b) => b.gszzl - a.gszzl);
        if (currentSort === 'amt') list.sort((a,b) => b.amt - a.amt);

        list.forEach(f => {
            const p = f.amt * (f.gszzl / 100);
            const v = f.amt + p;
            totalM += v; totalP += p;
            const cls = f.gszzl > 0 ? 'up' : (f.gszzl < 0 ? 'down' : 'gray');
            const sign = f.gszzl > 0 ? '+' : '';

            container.innerHTML += `
                <div class="card">
                    <div class="card-head">
                        <div class="f-name">${f.name}</div>
                        <span class="f-code">${f.code}</span>
                        <div class="f-rate ${cls}">${sign}${f.gszzl.toFixed(2)}%</div>
                        <div class="f-time">${f.time}</div>
                    </div>
                    <div class="card-body">
                        <div class="cb-item"><label>æŒæœ‰æœ¬é‡‘</label><span>${f.amt.toLocaleString()}</span></div>
                        <div class="cb-item"><label>ä»Šæ—¥ç›ˆäº</label><span class="${cls}">${sign}${p.toFixed(2)}</span></div>
                        <div class="cb-item"><label>ä¼°ç®—å¸‚å€¼</label><span>${v.toFixed(2)}</span></div>
                    </div>
                    <div class="card-actions">
                        <button class="btn-link" onclick="deleteFund(${f.id})">åˆ é™¤</button>
                    </div>
                </div>
            `;
        });

        document.getElementById('totalMoney').innerText = totalM.toLocaleString(undefined, {minimumFractionDigits: 2});
        const pEl = document.getElementById('totalProfit');
        pEl.innerText = (totalP > 0 ? '+' : '') + totalP.toLocaleString(undefined, {minimumFractionDigits: 2});
        pEl.style.color = totalP > 0 ? 'var(--red)' : (totalP < 0 ? 'var(--green)' : 'var(--text-secondary)');
    }

    function deleteFund(id) { if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) { myFunds = myFunds.filter(f => f.id !== id); save(); render(); } }
    function settleAccounts() {
        if(!confirm("ç¡®å®šç»“ç®—å—ï¼Ÿæœ¬é‡‘å°†æ›´æ–°ä¸ºå½“å‰å¸‚å€¼ã€‚")) return;
        myFunds.forEach(f => { f.amt = parseFloat((f.amt + f.amt*(f.gszzl/100)).toFixed(2)); f.gszzl = 0; });
        save(); render(); alert("ç»“ç®—å®Œæˆ");
    }
    function switchView(mode) {
        document.getElementById('fundContainer').className = `fund-container ${mode}-mode`;
        document.getElementById('btnGrid').classList.toggle('active', mode === 'grid');
        document.getElementById('btnList').classList.toggle('active', mode === 'list');
        localStorage.setItem('fn_view_mode', mode);
    }
    function sortFunds(v) { currentSort = v; render(); }
    function save() { localStorage.setItem(KEY, JSON.stringify(myFunds)); }
    function showModal(id) { document.getElementById(id + 'Modal').style.display = 'flex'; }
    function hideModal(id) { document.getElementById(id + 'Modal').style.display = 'none'; }
</script>
</body>
</html>
