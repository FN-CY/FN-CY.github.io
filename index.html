<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RCç†è´¢</title>
    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --text: #e0e0e0;
            --text-sub: #757575;
            --red: #eb4d3d; 
            --green: #00a854; 
            --blue: #2196f3;
            --border: #333;
            --modal-bg: #252525;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, "Microsoft YaHei", sans-serif;
            margin: 0;
            padding: 15px; /* æ‰‹æœºç«¯è¾¹è·è°ƒå° */
        }

        .container { max-width: 950px; margin: 0 auto; padding-bottom: 50px;}
        
        h1 {
            text-align: center; font-size: 1.5rem; margin-bottom: 20px;
            color: var(--text); font-weight: bold; letter-spacing: 1px;
        }

        /* é¡¶éƒ¨çœ‹æ¿ */
        .dashboard {
            background-color: var(--card); border-radius: 10px; padding: 20px;
            border: 1px solid var(--border); display: flex;
            justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        .dash-item .label { color: var(--text-sub); font-size: 0.85em; margin-bottom: 5px; }
        .dash-item .val { font-size: 1.6em; font-weight: bold; }

        /* é¢œè‰² */
        .up { color: var(--red); } .down { color: var(--green); } .gray { color: var(--text-sub); }

        /* è¾“å…¥åŒº */
        .input-area {
            background-color: var(--card); padding: 15px; border-radius: 10px;
            margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap;
        }
        input {
            background: #2c2c2c; border: 1px solid #444; color: white;
            padding: 10px; border-radius: 5px; flex: 1; outline: none; min-width: 80px;
        }
        button {
            border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;
            font-weight: bold; color: white; font-size: 0.9em;
        }
        .btn-add { background-color: var(--blue); }
        .btn-refresh { background-color: #333; border: 1px solid #555; }

        /* è¡¨æ ¼ */
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; margin-top: 5px; min-width: 600px; }
        th { text-align: left; color: var(--text-sub); font-size: 0.85em; padding: 10px; border-bottom: 1px solid var(--border); white-space: nowrap;}
        td { padding: 12px 10px; border-bottom: 1px solid #2a2a2a; font-size: 0.95em; }
        
        .code-pill { background: #2a2a2a; color: #888; font-size: 0.75em; padding: 2px 5px; border-radius: 4px; display: inline-block; transform: scale(0.9);}

        .del-btn { background: none; color: #666; padding: 5px; font-size: 1.2em;}
        .chart-btn { background: #333; color: #ccc; padding: 4px 8px; font-size: 0.8em; margin-right: 5px; }
        
        .tips { margin-top: 20px; padding: 15px; background: #1a1a1a; color: #666; font-size: 0.8em; border-radius: 8px; }
        .tips code { color: #ccc; background: #333; padding: 2px 4px; border-radius: 3px; }

        /* --- å¼¹çª—æ ·å¼ --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 999; display: none;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--modal-bg); width: 95%; max-width: 600px;
            border-radius: 12px; padding: 15px; position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid #444;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-title { font-size: 1.1em; font-weight: bold; }
        .close-modal { background: none; font-size: 1.5em; color: #888; padding: 0; }
        
        .chart-tabs { display: flex; gap: 10px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px;}
        .tab-btn { 
            background: #333; flex: 1; padding: 8px 0; text-align: center; 
            border-radius: 4px; font-size: 0.85em; white-space: nowrap;
        }
        .tab-btn.active { background: var(--blue); color: white; }
        
        .chart-img-container { 
            background: #fff; border-radius: 4px; padding: 5px; 
            min-height: 200px; display: flex; justify-content: center; align-items: center;
        }
        .chart-img { width: 100%; height: auto; display: block; }
        .loading-text { color: #333; }
    </style>
</head>
<body>

<div class="container">
    <h1>RCï¼šç»™æˆ‘ä¸€ç›´çº¢ä¸‹å»ï¼ï¼ï¼</h1>

    <div class="dashboard">
        <div class="dash-item">
            <div class="label">æ€»æœ¬é‡‘</div>
            <div class="val" id="totalMoney">0.00</div>
        </div>
        <div class="dash-item">
            <div class="label">ä»Šæ—¥ç›ˆäº</div>
            <div class="val" id="totalProfit">0.00</div>
        </div>
        <div style="text-align: right;">
            <button class="btn-refresh" onclick="fetchData()">åˆ·æ–°</button>
            <div id="networkStatus" style="font-size:0.75em; color:#666; margin-top:5px;">å‡†å¤‡å°±ç»ª</div>
        </div>
    </div>

    <div class="input-area">
        <input type="text" id="inCode" placeholder="ä»£ç  (å¦‚ sh600519)">
        <input type="text" id="inName" placeholder="åç§°">
        <input type="number" id="inAmt" placeholder="æœ¬é‡‘">
        <button class="btn-add" onclick="add()">æ·»åŠ </button>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>åç§°</th>
                    <th>æœ¬é‡‘</th>
                    <th>ç°ä»·</th>
                    <th>æ¶¨è·Œå¹…</th>
                    <th>ä»Šæ—¥ç›ˆäº</th>
                    <th style="text-align: right;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="list"></tbody>
        </table>
    </div>

    <div class="tips">
        <strong>âš¡ FNCYï¼š</strong><br>
        Aè‚¡: <code>sh600519</code>, <code>sz300750</code> | æ¸¯è‚¡: <code>hk00700</code> | ç¾è‚¡: <code>usTSLA.TSLA</code>
    </div>
</div>

<!-- èµ°åŠ¿å›¾å¼¹çª— -->
<div class="modal-overlay" id="chartModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">èŒ…å° (600519)</div>
            <button class="close-modal" onclick="closeChart()">Ã—</button>
        </div>
        <div class="chart-tabs">
            <button class="tab-btn active" onclick="switchChart('min')">ä»Šæ—¥åˆ†æ—¶(å®æ—¶)</button>
            <button class="tab-btn" onclick="switchChart('daily')">æ—¥K (1-3æœˆ)</button>
            <button class="tab-btn" onclick="switchChart('weekly')">å‘¨K (1å¹´)</button>
            <button class="tab-btn" onclick="switchChart('monthly')">æœˆK (3å¹´)</button>
        </div>
        <div class="chart-img-container">
            <img id="chartImg" class="chart-img" src="" alt="èµ°åŠ¿å›¾">
        </div>
        <div style="margin-top:10px; font-size:0.8em; color:#666; text-align:center;">
            * å›¾è¡¨æ•°æ®æ¥æºï¼šSina Financeï¼ˆFN:ä»…ä¾›å‚è€ƒï¼‰
        </div>
    </div>
</div>

<script>
    let assets = [];
    let currentChartCode = '';
    let currentChartType = '';
    let chartTimer = null; // è‡ªåŠ¨åˆ·æ–°å›¾ç‰‡çš„å®šæ—¶å™¨
    
    window.onload = () => {
        const local = localStorage.getItem('tencent_fund_v1');
        if(local) assets = JSON.parse(local);
        render();
        if(assets.length) fetchData();
    };

    function add() {
        const code = document.getElementById('inCode').value.trim();
        const name = document.getElementById('inName').value.trim();
        const amt = parseFloat(document.getElementById('inAmt').value);

        if(!code || !name || isNaN(amt)) return alert("è¯·å¡«å…¨ä¿¡æ¯");
        if(!/^(sh|sz|hk|us)/.test(code)) return alert("ä»£ç å‰ç¼€é”™è¯¯ï¼Œè¯·çœ‹åº•éƒ¨è¯´æ˜");

        assets.push({ id: Date.now(), code, name, amt, price: 0, pct: 0 });
        save(); render(); fetchData();
        
        document.getElementById('inCode').value = '';
        document.getElementById('inName').value = '';
        document.getElementById('inAmt').value = '';
    }

    function del(id) {
        if(confirm('åˆ é™¤æ­¤é¡¹?')) {
            assets = assets.filter(a => a.id !== id);
            save(); render();
        }
    }

    function save() { localStorage.setItem('tencent_fund_v1', JSON.stringify(assets)); }

    // --- æ ¸å¿ƒï¼šæ•°æ®è·å– ---
    function fetchData() {
        if(!assets.length) return;
        const statusDiv = document.getElementById('networkStatus');
        statusDiv.innerHTML = "æ›´æ–°ä¸­...";
        
        const codes = assets.map(a => a.code).join(',');
        const script = document.createElement('script');
        script.charset = "gbk"; 
        script.src = `https://qt.gtimg.cn/q=${codes}&_t=${Date.now()}`;

        script.onload = () => {
            assets.forEach(a => {
                const varName = `v_${a.code.replace(/\./g, '_')}`;
                const dataStr = window[varName];
                if(dataStr) {
                    const params = dataStr.split('~');
                    if(params.length > 30) {
                        if(a.code.startsWith('us')) { // ç¾è‚¡ç‰¹æ®Šå¤„ç†
                            a.price = parseFloat(params[3]);
                            a.pct = parseFloat(params[32]); 
                        } else {
                            a.price = parseFloat(params[3]);
                            a.pct = parseFloat(params[32]);
                        }
                    }
                }
            });
            render();
            statusDiv.innerHTML = `æ›´æ–°äº ${new Date().toLocaleTimeString()}`;
        };
        document.body.appendChild(script);
    }

    function render() {
        const list = document.getElementById('list');
        list.innerHTML = '';
        let totalM = 0, totalP = 0;

        assets.forEach(a => {
            const profit = a.amt * (a.pct / 100);
            totalM += a.amt; totalP += profit;
            
            const color = a.pct > 0 ? 'up' : (a.pct < 0 ? 'down' : 'gray');
            const sign = a.pct > 0 ? '+' : '';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div>${a.name}</div>
                    <div class="code-pill">${a.code}</div>
                </td>
                <td>Â¥${a.amt.toLocaleString()}</td>
                <td>${a.price || '-'}</td>
                <td class="${color}">${sign}${a.pct.toFixed(2)}%</td>
                <td class="${color}" style="font-weight:bold">${sign}${profit.toFixed(2)}</td>
                <td style="text-align: right;">
                    <button class="chart-btn" onclick="openChart('${a.code}', '${a.name}')">ğŸ“‰èµ°åŠ¿</button>
                    <button class="del-btn" onclick="del(${a.id})">Ã—</button>
                </td>
            `;
            list.appendChild(tr);
        });

        document.getElementById('totalMoney').innerText = totalM.toLocaleString();
        const pEl = document.getElementById('totalProfit');
        pEl.innerText = (totalP > 0 ? '+' : '') + totalP.toFixed(2);
        pEl.className = 'val ' + (totalP > 0 ? 'up' : (totalP < 0 ? 'down' : 'gray'));
    }

    // --- å›¾è¡¨é€»è¾‘ ---
    
    // æ‰“å¼€å¼¹çª—
    function openChart(code, name) {
        currentChartCode = code;
        document.getElementById('modalTitle').innerText = `${name} (${code})`;
        document.getElementById('chartModal').style.display = 'flex';
        switchChart('min'); // é»˜è®¤çœ‹åˆ†æ—¶
        
        // å¦‚æœæ˜¯ä»Šæ—¥èµ°åŠ¿ï¼Œå¼€å¯å®šæ—¶åˆ·æ–°
        if(chartTimer) clearInterval(chartTimer);
        chartTimer = setInterval(() => {
            if(currentChartType === 'min') updateChartImage();
        }, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡å›¾
    }

    // å…³é—­å¼¹çª—
    function closeChart() {
        document.getElementById('chartModal').style.display = 'none';
        if(chartTimer) clearInterval(chartTimer);
    }

    // åˆ‡æ¢å‘¨æœŸ
    function switchChart(type) {
        currentChartType = type;
        
        // æŒ‰é’®æ ·å¼åˆ‡æ¢
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active'); // æ³¨æ„ï¼šè¿™é‡Œçš„eventæ˜¯å†…è”è°ƒç”¨ï¼Œå¦‚æœæŠ¥é”™éœ€æ”¹å†™
        // ä¿®æ­£æŒ‰é’®é«˜äº®é€»è¾‘
        const btns = document.querySelectorAll('.tab-btn');
        if(type === 'min') btns[0].classList.add('active');
        if(type === 'daily') btns[1].classList.add('active');
        if(type === 'weekly') btns[2].classList.add('active');
        if(type === 'monthly') btns[3].classList.add('active');

        updateChartImage();
    }

    // è·å–å›¾ç‰‡URLé€»è¾‘
    function updateChartImage() {
        const img = document.getElementById('chartImg');
        const code = currentChartCode;
        const type = currentChartType;
        let url = '';

        // æ–°æµªå›¾ç‰‡æ¥å£è§„åˆ™è½¬æ¢
        // è…¾è®¯: sh600519 -> æ–°æµª: sh600519
        // è…¾è®¯: hk00700  -> æ–°æµª: 00700 (è·¯å¾„ä¸åŒ)
        // è…¾è®¯: usTSLA.TSLA -> æ–°æµª: tsla (è·¯å¾„ä¸åŒ)

        if(code.startsWith('sh') || code.startsWith('sz')) {
            // Aè‚¡
            url = `https://image.sinajs.cn/newchart/${type}/n/${code}.gif`;
        } else if(code.startsWith('hk')) {
            // æ¸¯è‚¡
            const cleanCode = code.replace('hk', '');
            url = `https://image.sinajs.cn/newchart/hk/${type}/${cleanCode}.gif`;
        } else if(code.startsWith('us')) {
            // ç¾è‚¡ (è…¾è®¯ usTSLA.TSLA -> æ–°æµª tsla)
            // æå– us å’Œ . ä¹‹é—´çš„éƒ¨åˆ†ï¼Œæˆ–è€…ç›´æ¥å– . åé¢çš„å¹¶è½¬å°å†™
            let cleanCode = code.split('.')[0].replace('us', '').toLowerCase();
            url = `https://image.sinajs.cn/newchart/us/${type}/${cleanCode}.gif`;
        }

        // åŠ ä¸Šæ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜ï¼Œå®ç°å®æ—¶åˆ·æ–°
        img.src = `${url}?t=${Date.now()}`;
    }

    // ç‚¹å‡»é®ç½©å…³é—­
    document.getElementById('chartModal').addEventListener('click', function(e) {
        if (e.target === this) closeChart();
    });

</script>

</body>
</html>

