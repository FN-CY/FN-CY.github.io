<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RCç†è´¢</title>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --text-sub: #888;
            --red: #eb4d3d; --green: #00a854; --blue: #2196f3; --border: #333;
            --modal-bg: #252525;
        }

        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, "Microsoft YaHei", sans-serif; margin: 0; padding: 15px; }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: 80px; }
        
        h1 { text-align: center; font-size: 1.5rem; margin-bottom: 25px; color: var(--text); font-weight: bold; letter-spacing: 1px; }

        /* çœ‹æ¿ */
        .dashboard {
            background-color: var(--card); border-radius: 10px; padding: 20px;
            border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .dash-item .label { color: var(--text-sub); font-size: 0.85em; margin-bottom: 5px; }
        .dash-item .val { font-size: 1.8em; font-weight: bold; }

        .up { color: var(--red); } .down { color: var(--green); } .gray { color: var(--text-sub); }

        /* è¾“å…¥åŒº */
        .input-group {
            background: var(--card); padding: 15px; border-radius: 10px; border: 1px solid var(--border);
            display: flex; gap: 10px; margin-bottom: 20px;
        }
        input {
            background: #2c2c2c; border: 1px solid #444; color: white;
            padding: 12px; border-radius: 5px; flex: 1; outline: none; font-size: 1em; width: 100px;
        }
        button {
            border: none; padding: 0 15px; border-radius: 5px; cursor: pointer;
            font-weight: bold; color: white; font-size: 0.9em; white-space: nowrap;
        }
        .btn-add { background-color: var(--blue); }
        .btn-refresh { background-color: #333; border: 1px solid #555; color: #ccc; font-size: 0.8em; padding: 6px 12px; }

        /* åº•éƒ¨æ¡ */
        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .status-text { font-size: 0.8em; color: #666; }

        /* åˆ—è¡¨ */
        .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; border: 1px solid var(--border); background: var(--card); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; color: var(--text-sub); font-size: 0.85em; padding: 12px; border-bottom: 1px solid var(--border); white-space: nowrap;}
        td { padding: 15px 12px; border-bottom: 1px solid #2a2a2a; font-size: 1em; }
        
        .code-tag { background: #2a2a2a; color: #666; font-size: 0.75em; padding: 2px 5px; border-radius: 3px; margin-left: 5px; }
        .time-tag { font-size: 0.75em; color: #555; display: block; margin-top: 4px; }

        /* æŒ‰é’® */
        .btn-del { background: none; color: #666; font-size: 1.5em; padding: 0 5px; line-height: 1; vertical-align: middle;}
        .btn-del:hover { color: var(--red); }
        .btn-chart { background: #333; color: #ccc; font-size: 0.8em; padding: 5px 10px; border-radius: 4px; margin-right: 10px; }

        /* --- å¼¹çª—æ ·å¼ --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 999; display: none;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--modal-bg); width: 95%; max-width: 600px;
            border-radius: 12px; padding: 15px; position: relative; border: 1px solid #444;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-title { font-size: 1.1em; font-weight: bold; }
        .close-modal { background: none; font-size: 1.5em; color: #888; padding: 0; }
        
        .chart-tabs { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { 
            background: #333; flex: 1; padding: 8px 0; text-align: center; 
            border-radius: 4px; font-size: 0.8em; white-space: nowrap; color: #ccc;
        }
        .tab-btn.active { background: var(--blue); color: white; }
        
        .chart-box { 
            background: #fff; border-radius: 4px; padding: 5px; 
            min-height: 200px; display: flex; justify-content: center; align-items: center;
        }
        .chart-img { width: 100%; height: auto; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h1>å°ğŸ·ç†è´¢ï¼ˆâ—'â—¡'â—ï¼ï¼‰</h1>

    <div class="dashboard">
        <div class="dash-item">
            <div class="label">æ€»æœ¬é‡‘</div>
            <div class="val" id="totalMoney">0.00</div>
        </div>
        <div class="dash-item">
            <div class="label">ä»Šæ—¥é¢„ä¼°ç›ˆäº</div>
            <div class="val" id="totalProfit">0.00</div>
        </div>
    </div>

    <div class="action-bar">
        <div class="status-text" id="statusMsg">å‡†å¤‡å°±ç»ª</div>
        <button class="btn-refresh" onclick="refreshAll()">â†» ç«‹å³åˆ·æ–°</button>
    </div>

    <div class="input-group">
        <input type="tel" id="inCode" placeholder="åŸºé‡‘ä»£ç  (6ä½)" maxlength="6">
        <input type="number" id="inAmt" placeholder="æŠ•å…¥æœ¬é‡‘">
        <button class="btn-add" onclick="addFund()">æ·»åŠ </button>
    </div>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>åŸºé‡‘åç§°</th>
                    <th>æœ¬é‡‘</th>
                    <th>å®æ—¶ä¼°å€¼</th>
                    <th>é¢„ä¼°ç›ˆäº</th>
                    <th style="text-align: right;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="listBody"></tbody>
        </table>
    </div>
    
    <div style="margin-top:20px; font-size:0.8em; color:#555; text-align:center; line-height: 1.6;">
        *å°ğŸ·:æ•°æ®ä»…ä¾›å‚è€ƒï¼è¯¥æ¶¨è¿˜æ˜¯å¾—æ¶¨
        * æ•°æ®æºï¼šOfficial Real-time Valuation API(JSONP)<br>
        * èµ°åŠ¿å›¾æ•°æ®æ¥æºï¼šTiantian Fund (Eastmoney)
    </div>
</div>

<!-- èµ°åŠ¿å›¾å¼¹çª— -->
<div class="modal-overlay" id="chartModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">åŸºé‡‘èµ°åŠ¿</div>
            <button class="close-modal" onclick="closeChart()">Ã—</button>
        </div>
        <div class="chart-tabs">
            <button class="tab-btn active" onclick="switchChart('today')">ä»Šæ—¥ä¼°å€¼</button>
            <button class="tab-btn" onclick="switchChart('1m')">1ä¸ªæœˆ</button>
            <button class="tab-btn" onclick="switchChart('3m')">3ä¸ªæœˆ</button>
            <button class="tab-btn" onclick="switchChart('6m')">åŠå¹´</button>
            <button class="tab-btn" onclick="switchChart('1y')">1å¹´</button>
            <button class="tab-btn" onclick="switchChart('3y')">3å¹´</button>
        </div>
        <div class="chart-box">
            <img id="chartImg" class="chart-img" src="" alt="åŠ è½½ä¸­...">
        </div>
        <div style="margin-top:10px; font-size:0.75em; color:#666; text-align:center;">
            * FN:å›¾æ ‡æœ‰å»¶è¿Ÿï¼Œä»Šæ—¥å›¾è¡¨éœ€ä»Šæ—¥æ•°æ®æ›´æ–°åå¯æŸ¥çœ‹
        </div>
    </div>
</div>

<script>
    let myFunds = [];
    const BASE_URL = "https://fundgz.1234567.com.cn/js/";
    
    // å›¾è¡¨ç›¸å…³å˜é‡
    let currentChartCode = '';
    let chartTimer = null;

    window.onload = () => {
        const saved = localStorage.getItem('fn_stable_funds');
        if (saved) myFunds = JSON.parse(saved);
        render();
        if (myFunds.length > 0) refreshAll();
        setInterval(refreshAll, 30000); // 30ç§’åˆ·æ–°æ•°æ®
    };

    // 1. æ·»åŠ åŸºé‡‘
    function addFund() {
        const code = document.getElementById('inCode').value.trim();
        const amt = parseFloat(document.getElementById('inAmt').value);

        if (!code || code.length !== 6 || isNaN(amt)) return alert("è¯·è¾“å…¥6ä½ä»£ç å’Œæœ¬é‡‘");
        
        const newFund = {
            id: Date.now(),
            code: code,
            name: "åŠ è½½ä¸­...", 
            amt: amt,
            gszzl: 0, 
            time: "--:--"
        };

        myFunds.push(newFund);
        save(); render(); refreshAll();
        
        document.getElementById('inCode').value = '';
        document.getElementById('inAmt').value = '';
    }

    // 2. åˆ·æ–°ä¼°å€¼ (JSONP)
    function refreshAll() {
        if (myFunds.length === 0) return;
        const statusEl = document.getElementById('statusMsg');
        statusEl.innerText = "æ­£åœ¨åŒæ­¥æ•°æ®...";
        statusEl.style.color = "#2196f3";

        let completed = 0;
        myFunds.forEach(fund => {
            const script = document.createElement('script');
            script.src = `${BASE_URL}${fund.code}.js?rt=${Date.now()}`;
            
            window.jsonpgz = function(data) {
                if(data.fundcode === fund.code) {
                    fund.name = data.name; 
                    fund.gszzl = parseFloat(data.gszzl);
                    fund.time = data.gztime;
                }
            };

            script.onload = () => { completed++; checkDone(); };
            script.onerror = () => { completed++; checkDone(); }; // å¿½ç•¥é”™è¯¯
            
            document.body.appendChild(script);
            setTimeout(() => { if(script.parentNode) script.parentNode.removeChild(script); }, 2000);
        });

        function checkDone() {
            if(completed >= myFunds.length) {
                save(); render();
                statusEl.innerText = "æ›´æ–°æˆåŠŸ " + new Date().toLocaleTimeString();
                statusEl.style.color = "#00a854";
            }
        }
    }

    // 3. æ¸²æŸ“åˆ—è¡¨
    function render() {
        const tbody = document.getElementById('listBody');
        tbody.innerHTML = '';
        let totalM = 0, totalP = 0;

        myFunds.forEach(f => {
            const profit = f.amt * (f.gszzl / 100);
            totalM += f.amt; totalP += profit;
            
            const color = f.gszzl > 0 ? 'up' : (f.gszzl < 0 ? 'down' : 'gray');
            const sign = f.gszzl > 0 ? '+' : '';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div>${f.name}</div>
                    <span class="code-tag">${f.code}</span>
                </td>
                <td>Â¥${f.amt.toLocaleString()}</td>
                <td>
                    <span class="${color}" style="font-weight:bold">${sign}${f.gszzl}%</span>
                    <span class="time-tag">${f.time}</span>
                </td>
                <td class="${color}">${sign}${profit.toFixed(2)}</td>
                <td style="text-align: right;">
                    <button class="btn-chart" onclick="openChart('${f.code}', '${f.name}')">ğŸ“‰èµ°åŠ¿</button>
                    <button class="btn-del" onclick="del(${f.id})">Ã—</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('totalMoney').innerText = totalM.toLocaleString();
        const pEl = document.getElementById('totalProfit');
        pEl.innerText = (totalP > 0 ? '+' : '') + totalP.toFixed(2);
        pEl.className = 'val ' + (totalP > 0 ? 'up' : (totalP < 0 ? 'down' : 'gray'));
    }

    function del(id) {
        if(confirm('åˆ é™¤?')) { myFunds = myFunds.filter(f => f.id !== id); save(); render(); }
    }
    function save() { localStorage.setItem('fn_stable_funds', JSON.stringify(myFunds)); }

    // --- å›¾è¡¨é€»è¾‘ ---

    function openChart(code, name) {
        currentChartCode = code;
        document.getElementById('modalTitle').innerText = name;
        document.getElementById('chartModal').style.display = 'flex';
        switchChart('today'); // é»˜è®¤æ˜¾ç¤ºä»Šæ—¥
    }

    function closeChart() {
        document.getElementById('chartModal').style.display = 'none';
        if(chartTimer) clearInterval(chartTimer);
    }

    function switchChart(type) {
        // æŒ‰é’®æ ·å¼
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        // ç®€å•æŸ¥æ‰¾å¯¹åº”æŒ‰é’®é«˜äº®ï¼ˆé€šè¿‡æ–‡æœ¬åˆ¤æ–­ä¸å¤ªä¸¥è°¨ä½†ç®€å•ï¼‰
        const btns = document.querySelectorAll('.tab-btn');
        if(type === 'today') btns[0].classList.add('active');
        if(type === '1m') btns[1].classList.add('active');
        if(type === '3m') btns[2].classList.add('active');
        if(type === '6m') btns[3].classList.add('active');
        if(type === '1y') btns[4].classList.add('active');
        if(type === '3y') btns[5].classList.add('active');

        // è®¾ç½®å›¾ç‰‡æº
        const img = document.getElementById('chartImg');
        const ts = Date.now();
        let url = '';

        // å¤©å¤©åŸºé‡‘å®˜æ–¹å›¾ç‰‡æ¥å£
        if (type === 'today') {
            // ä»Šæ—¥å®æ—¶ä¼°å€¼èµ°åŠ¿
            url = `https://j4.dfcfw.com/charts/pic/${currentChartCode}.png?v=${ts}`;
            // å¼€å¯è‡ªåŠ¨åˆ·æ–° (ä»…ä»Šæ—¥å›¾)
            if(chartTimer) clearInterval(chartTimer);
            chartTimer = setInterval(() => {
                img.src = `https://j4.dfcfw.com/charts/pic/${currentChartCode}.png?v=${Date.now()}`;
            }, 30000);
        } else {
            // å†å²å‡€å€¼èµ°åŠ¿
            if(chartTimer) clearInterval(chartTimer);
            let pType = 1;
            if(type === '1m') pType = 1;
            if(type === '3m') pType = 2;
            if(type === '6m') pType = 3;
            if(type === '1y') pType = 4;
            if(type === '3y') pType = 5;
            
            url = `https://j3.dfcfw.com/images/JJJZ${pType}/${currentChartCode}.png?v=${ts}`;
        }
        
        img.src = url;
    }
    
    // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
    document.getElementById('chartModal').addEventListener('click', function(e){
        if(e.target === this) closeChart();
    });

</script>
</body>
</html>
